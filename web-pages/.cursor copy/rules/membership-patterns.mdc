# Membership and Payment Patterns

## Guest to Member Flow
1. New users start as guests (no membership)
2. Users can browse available memberships on the membership page
3. Checkout Process:
   - User selects membership type
   - Redirected to membership checkout page
   - Checkout modal connects to Stripe
   - Uses `membership_types.stripe_product_id` to fetch correct product
   - Processes payment through Stripe
   - Upon successful payment, membership is activated

## Event Access Requirements
### Waiver Requirement
- All users must sign a waiver before participating
- Tracked via `public.users.has_signed_waiver` boolean
- Must be verified before allowing event registration

### Event Pricing Model
1. Base Pricing:
   - All events have a default price
   - This is the price for non-members

2. Membership Discounts:
   - Active memberships may have associated `membership_discounts`
   - Discount is applied as a percentage reduction
   - Final price = Event Price × (1 - Discount Percentage)
   - Example:
     ```
     Event Price: $100
     Membership Discount: 20%
     Final Price = $100 × (1 - 0.20) = $80
     ```

## Database Access Patterns

### membership_types Table
- Public access:
  - Read access to available membership types and prices
- Admin access:
  - Full CRUD access to manage membership types

### membership_discounts Table
- Public access:
  - No direct access
- Authenticated access:
  - Read access to discounts associated with their active membership
- Admin access:
  - Full CRUD access to manage discounts

### memberships Table
- Public access:
  - No access
- Authenticated access:
  - Read access to own memberships
  - Create access for new memberships (via checkout)
- Admin access:
  - Full CRUD access to all memberships

## RLS Policy Patterns

### Memberships Table
```sql
-- Authenticated user access to own memberships
create policy "users_can_read_own_memberships" on memberships
  for select
  using (auth.uid() = user_id);

-- Allow users to create their own memberships
create policy "users_can_create_memberships" on memberships
  for insert
  with check (auth.uid() = user_id);

-- Admin full access
create policy "admin_full_access" on memberships
  for all
  using (
    exists (
      select 1 from users
      where id = auth.uid()
      and is_admin = true
    )
  );
```

### Membership Types Table
```sql
-- Public read access to membership types
create policy "public_read_membership_types" on membership_types
  for select
  using (true);

-- Admin full access
create policy "admin_full_access" on membership_types
  for all
  using (
    exists (
      select 1 from users
      where id = auth.uid()
      and is_admin = true
    )
  );
```

## Security Considerations
1. Always verify membership status before applying discounts
2. Validate waiver status before allowing event registration
3. Ensure Stripe product IDs are properly mapped
4. Implement proper error handling for failed payments
5. Keep membership status up to date

## Common Pitfalls
1. Not checking waiver status before registration
2. Incorrect discount calculations
3. Missing membership expiration checks
4. Not handling failed payments gracefully
5. Inconsistent price display between frontend and backend

## Testing Checklist
Before deploying membership changes:
1. Verify waiver check functionality
2. Test membership purchase flow
3. Validate discount calculations
4. Check RLS policies
5. Test admin access patterns

## Membership Activation & Role Management (2024)
- On successful payment, membership is activated and user's role is updated to 'member'.
- Remove duplicate API calls to activate membership.
- Membership activation flow should be robust and production-ready.
- (TODO) Automate role reversion on membership expiration.

## Known Issues (2024)
- Waiver prompt/signing flow is not working as expected; needs investigation.

## Testing & Success Criteria (2024)
- Guest can sign waiver and register for events.
- User can purchase membership.
- Member receives correct discounts on events.
- All registrations are properly recorded.
- Payments are processed correctly.
- See also: event-handling.mdc for event registration testing.

* ONCE YOU HAVE READ THIS FILE, PLEASE INCLUDE "I've read membership-patterns.mdc" IN THE RESPONSE *