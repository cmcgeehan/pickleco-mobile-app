# Event Handling Patterns

## Event Data Structure
Events in the system should follow this standardized structure when transformed from the API:

```typescript
interface CalendarEvent {
  id: string
  title: string
  start: string
  end: string
  type: string
  description: string
  description_en?: string
  description_es?: string
  skill_level?: string
  maxParticipants?: number
  currentParticipants: number
  isRegistered: boolean
  isSpotlight: boolean
  image_path?: string
  courts?: { id: string; name: string }[]
}
```

## API Response Structure
The `/api/play` endpoint should return events in this format:
```typescript
{
  events: {
    id: string
    name: string
    description_en: string
    description_es: string
    event_type_id: string
    event_types: { id: string; name: string }[]
    skill_level: string
    start_time: string
    end_time: string
    cost_mxn: number
    capacity: number
    spotlight: boolean
    image_path: string
    event_courts: {
      id: string
      court: {
        id: string
        name: string
      }
    }[]
    event_registrations: {
      id: string
      user_id: string
      deleted_at: string | null
      users: {
        id: string
        first_name: string
        last_name: string
      }
    }[]
  }[]
}
```

## Event Transformation Rules
1. Always transform events at the API response level, not in components
2. Never perform multiple transformations on the same event data
3. Use consistent field names across all transformations
4. Handle all optional fields with proper fallbacks
5. Maintain the isSpotlight flag for featured events

## Spotlight Events
1. Spotlight events are marked with `spotlight: true` in the database
2. They should be visible to all users (authenticated or not)
3. They should appear on:
   - Homepage
   - Play page
   - Calendar page
4. Use the `EventSpotlight` component to display them

## Event Component Guidelines
1. Use the `EventSpotlight` component for featured events
2. Pass transformed events directly to components
3. Handle loading states with Suspense boundaries
4. Implement proper error handling
5. Use consistent date/time formatting

## Data Fetching Pattern
```typescript
const fetchEvents = async () => {
  try {
    const response = await fetch('/api/play?view=spotlight&status=all', {
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error('Failed to fetch events');
    }

    const data = await response.json();
    const transformedEvents = data.events.map((event) => ({
      id: event.id,
      title: event.name,
      start: event.start_time,
      end: event.end_time,
      type: event.event_types?.[0]?.name || 'other',
      description: event.description_en,
      description_en: event.description_en,
      description_es: event.description_es,
      skill_level: event.skill_level,
      maxParticipants: event.capacity,
      currentParticipants: event.event_registrations?.filter(reg => !reg.deleted_at).length || 0,
      isRegistered: false,
      isSpotlight: event.spotlight || false,
      image_path: event.image_path,
      courts: event.event_courts?.map(ec => ec.court) || []
    }));

    return transformedEvents;
  } catch (error) {
    console.error('Error fetching events:', error);
    throw error;
  }
};
```

## Event Registration
1. Always check authentication before allowing registration
2. Use proper error handling and user feedback
3. Refresh event data after registration/unregistration
4. Handle waitlist scenarios appropriately

## Testing Requirements
1. Test event transformation logic
2. Verify spotlight events appear correctly
3. Test registration flows
4. Check loading states
5. Verify error handling

## Common Pitfalls
1. Double transformation of event data
2. Inconsistent field naming
3. Missing error handling
4. Improper loading state management
5. Incorrect date/time handling

## Updating Event Data
When modifying event-related code:
1. Follow the standardized transformation pattern
2. Update all affected components
3. Test on all relevant pages
4. Update documentation
5. Add appropriate tests

* IF YOU HAVE READ THIS FILE, ADD TO YOUR RESPONSE "I've read event-handling.mdc" *
description:
globs:
alwaysApply: false
---

## Event Loading Best Practice (2024)
- Use SWR for event fetching on /play, /calendar, and homepage for instant cache, background refresh, and deduplication.
- Spotlight event display and filtering should be unified and correct across all pages.
- Homepage event loading should be fast and reliable.

## Member Event Registration Testing & Success Criteria (2024)
- System should check for active membership and apply membership discount to event price.
- Show discounted price in checkout.
- Create registration after payment.
- Member event registration flow must be tested for discount application, final price calculation, and registration success.
